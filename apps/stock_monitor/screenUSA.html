<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨å¸‚å ´ç›£æ§ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #2E2E2E; color: #E0E0E0; font-family: 'Microsoft JhengHei UI', 'PingFang SC', sans-serif; font-size: 12px; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px 0; border-bottom: 2px solid #454545; margin-bottom: 20px;}
        header h1 { font-size: 28px; margin-bottom: 10px; }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background-color: #3A3A3A; padding: 15px; border-radius: 8px; }
        .control-group { display: flex; gap: 10px; align-items: center; }
        label { font-weight: bold; }
        select, button { padding: 8px 12px; background-color: #2E2E2E; color: #E0E0E0; border: 1px solid #454545; border-radius: 4px; font-size: 12px; font-family: inherit; cursor: pointer; }
        button { padding: 10px 20px; transition: all 0.3s ease; }
        button:hover { background-color: #4A4A4A; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress-message { text-align: center; padding: 15px; background-color: #3A3A3A; border-radius: 4px; margin-bottom: 15px;}
        .category-section { margin-bottom: 30px; }
        .category-title { background-color: #3A3A3A; padding: 12px 15px; font-weight: bold; font-size: 14px; border-left: 4px solid #50C878; margin-bottom: 10px; border-radius: 4px;}
        table { width: 100%; border-collapse: collapse; background-color: #2E2E2E; border: 1px solid #454545;}
        thead { background-color: #3A3A3A;}
        th { padding: 12px 15px; text-align: left; border: 1px solid #454545; font-weight: bold;}
        td { padding: 10px 15px; border: 1px solid #454545; }
        tr:hover { background-color: #353535; }
        .ticker { font-weight: bold; color: #50C878; }
        .name { color: #B0B0B0; font-size: 11px; }
        .price { text-align: right; font-weight: bold;}
        .change { text-align: right; padding: 8px 12px; border-radius: 4px; font-weight: bold;}
        .change.positive { color: #50C878; background-color: rgba(80, 200, 120, 0.15);}
        .change.negative { color: #FF5733; background-color: rgba(255, 87, 51, 0.15);}
        .rsi { text-align: right; font-weight: bold;}
        .rsi.overbought { color: #FF5733;}
        .rsi.oversold { color: #50C878;}
        .error { color: #FF5733; padding: 15px; background-color: rgba(255, 87, 51, 0.15); border-left: 4px solid #FF5733; border-radius: 4px;}
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;}
        .stat-card { background-color: #3A3A3A; padding: 15px; border-radius: 4px; border-left: 4px solid #50C878; text-align: center;}
        .stat-label { font-size: 11px; color: #808080;}
        .stat-value { font-size: 20px; font-weight: bold; color: #50C878;}
        @media (max-width: 768px) { .controls { flex-direction: column; }
            .control-group { width: 100%; } select, button { width: 100%; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ“Š è‚¡ç¥¨å¸‚å ´ç›£æ§ç³»çµ±</h1>
        <p>å¯¦æ™‚ç›£æ§ç¾è‚¡æŒ‡æ•¸ã€ETFã€åŠ å¯†è²¨å¹£èˆ‡å€‹è‚¡è¡¨ç¾</p>
    </header>

    <div class="controls">
        <div class="control-group">
            <label for="categoryFilter">ç¯©é¸é¡åˆ¥ï¼š</label>
            <select id="categoryFilter">
                <option value="">å…¨éƒ¨é¡åˆ¥</option>
            </select>
        </div>
        <button id="loadBtn">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <button id="exportBtn">ğŸ’¾ åŒ¯å‡º CSV</button>
    </div>

    <div class="progress-message" id="progressMessage">
        æº–å‚™å°±ç·’
    </div>

    <div id="statsBar" class="stats-bar"></div>
    <div id="contentArea"></div>
</div>

<script>
    // ==================== API è¨­å®š ====================
    const API_URL = 'https://stock-monitor-backend-tb9x.onrender.com'; // æ”¹æˆä½ çš„ Render ç¶²å€

    let allData = [];
    let filteredData = [];

    // ==================== å·¥å…·å‡½æ•¸ ====================

    function formatPercent(value) {
        if (value === null || isNaN(value)) return "N/A";
        const sign = value >= 0 ? "+" : "";
        return sign + value.toFixed(2) + "%";
    }

    function formatPrice(price) {
        return price.toFixed(2);
    }

    function getRSIStatus(rsi) {
        if (rsi === null) return { class: "neutral", label: "N/A" };
        if (rsi > 70) return { class: "overbought", label: "è¶…è²·" };
        if (rsi < 30) return { class: "oversold", label: "è¶…è³£" };
        return { class: "neutral", label: "ä¸­æ€§" };
    }

    async function loadData() {
        const loadBtn = document.getElementById("loadBtn");
        loadBtn.disabled = true;
        loadBtn.textContent = "â³ æ­£åœ¨é€£æ¥å¾Œç«¯ç²å–æ•¸æ“š...";

        updateProgress("ğŸ” æ­£åœ¨é€£æ¥å¾Œç«¯ç²å–æ•¸æ“š...");

        try {
            // èª¿ç”¨ Render å¾Œç«¯ API (ç²å–å®Œæ•´æ‰€æœ‰é¡åˆ¥+æ‰€æœ‰æ¨™çš„)
            const response = await fetch(`${API_URL}/api/stocks`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            allData = [];
            // å®Œå…¨æŒ‰ç…§ä½ çš„ Python åˆ†é¡
            for (const [category, tickers] of Object.entries(data)) {
                for (const [ticker, stockData] of Object.entries(tickers)) {
                    allData.push(stockData);
                }
            }

            updateProgress(`âœ… æ•¸æ“šè¼‰å…¥å®Œæˆï¼å…± ${allData.length} å€‹æ¨™çš„`);
            initCategoryFilter();
            filterAndDisplay();

        } catch (error) {
            updateProgress(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            showError(`ç„¡æ³•é€£æ¥å¾Œç«¯: ${error.message}\n\nå¯èƒ½åŸå› ï¼š\n1. Render å¾Œç«¯å°šæœªå•Ÿå‹•ï¼ˆé¦–æ¬¡è¨ªå•éœ€ 10-20 ç§’ï¼‰\n2. å¾Œç«¯ URL éŒ¯èª¤\n3. ç¶²è·¯é€£æ¥å•é¡Œ\n\nç•¶å‰å¾Œç«¯ URL: ${API_URL}`);
        } finally {
            loadBtn.disabled = false;
            loadBtn.textContent = "ğŸ”„ é‡æ–°è¼‰å…¥";
        }
    }

    function initCategoryFilter() {
        const select = document.getElementById("categoryFilter");
        while (select.options.length > 1) select.remove(1);

        const categories = [...new Set(allData.map(item => item.category))];
        categories.forEach(category => {
            const option = document.createElement("option");
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
        });

        select.onchange = filterAndDisplay;
    }

    function filterAndDisplay() {
        const categoryFilter = document.getElementById("categoryFilter").value;
        filteredData = categoryFilter
            ? allData.filter(item => item.category === categoryFilter)
            : [...allData];
        displayData();
        updateStats();
    }

    function displayData() {
        const contentArea = document.getElementById("contentArea");
        contentArea.innerHTML = "";

        if (filteredData.length === 0) {
            contentArea.innerHTML = "<p style='text-align:center;color:#808080;'>æ²’æœ‰å¯é¡¯ç¤ºçš„æ•¸æ“š</p>";
            return;
        }

        // æŒ‰é¡åˆ¥åˆ†çµ„
        const grouped = {};
        filteredData.forEach(item => {
            if (!grouped[item.category]) grouped[item.category] = [];
            grouped[item.category].push(item);
        });

        // ç‚ºæ¯å€‹é¡åˆ¥å»ºç«‹è¡¨æ ¼
        for (const [category, items] of Object.entries(grouped)) {
            const section = document.createElement("div");
            section.className = "category-section";

            const title = document.createElement("div");
            title.className = "category-title";
            title.textContent = category + ` (${items.length} å€‹æ¨™çš„)`;
            section.appendChild(title);

            const table = document.createElement("table");
            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");

            const headers = ["ä»£ç¢¼", "åç¨±", "ç¾åƒ¹", "æ—¥", "é€±", "æœˆ", "å¹´åˆè‡³ä»Š", "RSI"];
            headers.forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            items.forEach(item => {
                const row = document.createElement("tr");

                const tickerCell = document.createElement("td");
                tickerCell.className = "ticker";
                tickerCell.textContent = item.ticker;
                row.appendChild(tickerCell);

                const nameCell = document.createElement("td");
                nameCell.className = "name";
                nameCell.textContent = item.name;
                row.appendChild(nameCell);

                const priceCell = document.createElement("td");
                priceCell.className = "price";
                priceCell.textContent = "$" + formatPrice(item.price);
                row.appendChild(priceCell);

                [item.day, item.week, item.month, item.ytd].forEach(change => {
                    const cell = document.createElement("td");
                    cell.className = "change " + (change >= 0 ? "positive" : "negative");
                    cell.textContent = formatPercent(change);
                    row.appendChild(cell);
                });

                const rsiCell = document.createElement("td");
                const rsiStatus = getRSIStatus(item.rsi);
                rsiCell.className = "rsi " + rsiStatus.class;
                rsiCell.textContent = item.rsi !== null ? item.rsi.toFixed(1) + " (" + rsiStatus.label + ")" : "N/A";
                row.appendChild(rsiCell);

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            section.appendChild(table);
            contentArea.appendChild(section);
        }
    }

    function updateStats() {
        const statsBar = document.getElementById("statsBar");
        const positiveCount = filteredData.filter(d => d.day >= 0).length;
        const negativeCount = filteredData.filter(d => d.day < 0).length;
        const avgDay = filteredData.reduce((sum, d) => sum + d.day, 0) / filteredData.length;

        statsBar.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">ä¸Šæ¼²</div>
                <div class="stat-value" style="color: #50C878;">${positiveCount}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä¸‹è·Œ</div>
                <div class="stat-value" style="color: #FF5733;">${negativeCount}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡æ¼²è·Œå¹…</div>
                <div class="stat-value" style="color: ${avgDay >= 0 ? '#50C878' : '#FF5733'};">${formatPercent(avgDay)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç¸½è¨ˆæ¨™çš„</div>
                <div class="stat-value">${filteredData.length}</div>
            </div>
        `;
    }

    function updateProgress(message) {
        document.getElementById("progressMessage").textContent = message;
    }

    function showError(message) {
        const contentArea = document.getElementById("contentArea");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.style.whiteSpace = "pre-wrap";
        errorDiv.textContent = message;
        contentArea.innerHTML = "";
        contentArea.appendChild(errorDiv);
    }

    function exportToCSV() {
        if (filteredData.length === 0) {
            alert("æ²’æœ‰æ•¸æ“šå¯åŒ¯å‡º");
            return;
        }
        let csv = "ä»£ç¢¼,åç¨±,é¡åˆ¥,ç¾åƒ¹,æ—¥æ¼²è·Œ,é€±æ¼²è·Œ,æœˆæ¼²è·Œ,å¹´åˆè‡³ä»Š,RSI\n";
        filteredData.forEach(item => {
            csv += `${item.ticker},"${item.name}","${item.category}",${item.price.toFixed(2)},${item.day.toFixed(2)},${item.week.toFixed(2)},${item.month.toFixed(2)},${item.ytd.toFixed(2)},${item.rsi !== null ? item.rsi.toFixed(2) : "N/A"}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `stock_market_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("loadBtn").addEventListener("click", loadData);
        document.getElementById("exportBtn").addEventListener("click", exportToCSV);
        loadData();
    });
    setInterval(loadData, 180000);
</script>
</body>
</html>
